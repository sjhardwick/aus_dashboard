# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Australian Macroeconomic Dashboard — a single-file Python application (`gdp_contributions.py`) that fetches live data from ABS (Australian Bureau of Statistics) and RBA APIs, generates interactive Plotly charts with automated narrative insights, and outputs a self-contained HTML dashboard (`dashboard.html`).

## Running the Dashboard

```bash
pip install -r requirements.txt
python gdp_contributions.py
```

This fetches live data, generates `dashboard.html`, and opens it in the default browser. Requires internet access for API calls.

## Architecture

The entire application lives in `gdp_contributions.py` (~1950 lines) with three logical layers:

1. **Data fetching** — Functions like `fetch_abs_csv()`, `fetch_abs_codelist()` call the ABS SDMX REST API (`data.api.abs.gov.au`) and RBA Excel endpoints. Each macro domain has its own fetcher: `get_gdp_contributions()`, `get_current_account()`, `get_trade_data()`, `get_inflation_rba()`, `get_labour_force()`, `get_merch_trade_tables()`.

2. **Anomaly/narrative detection** — A suite of statistical detectors (`detect_outlier`, `detect_large_change`, `detect_consecutive_trend`, `detect_cumulative_trend`, `detect_threshold_crossing`, `detect_rolling_trend`, `detect_volatility_change`, `detect_base_effect`, `detect_persistence_change`, `find_trend_window`) that flag unusual patterns in time series. These are orchestrated by `generate_insights()` which runs all detectors across GDP, current account, inflation, and labour data, deduplicates findings, and caps output at 8 insights. The design philosophy is documented in `documents/Time-series narrative detection shortlist.md`.

3. **Visualization & HTML output** — Plotly chart builders (`create_contributions_chart`, `create_current_account_chart`, `create_trade_chart`, `create_dashboard`) and `create_html_with_insights()` which assembles a tabbed HTML page (Big Picture / Trade tabs) with embedded charts and an insights box. Trade breakdown tables are generated by `generate_trade_tables_html()`.

## Key Data Sources & Identifiers

- **ABS API**: SDMX REST at `https://data.api.abs.gov.au/rest/data`. Dataflows: `ABS,ANA_EXP` (national accounts), `ABS,BOP` (balance of payments), `ABS,LF` (labour force), `ABS,MERCH_EXP` / `ABS,MERCH_IMP` (merchandise trade).
- **RBA**: Excel download from `rba.gov.au/statistics/tables/xls/g01hist.xlsx` for CPI/trimmed mean inflation.
- Component codes are defined as module-level dicts (`GDP_COMPONENTS`, `CA_COMPONENTS`, `TRADE_COMPONENTS`, `LF_MEASURES`, `SITC_2DIGIT_CODES`).

## Important Patterns

- All monetary values from ABS BOP are converted from millions to billions (`/ 1000`).
- Merchandise trade values from MERCH_EXP/MERCH_IMP are in AUD thousands, converted to billions (`/ 1_000_000`).
- Quarterly data uses `TIME_PERIOD` format `YYYY-QN`; monthly uses `YYYY-MM` (labour) or `Mon YYYY` after formatting.
- The insight system uses z-score thresholds (typically 1.3–2.0) and deduplication via `_dedup_ok()` to avoid redundant findings.
- `find_trend_window()` uses a lightweight structural-break approach (Welch t-test scanning) to adaptively choose the relevant trend window rather than using a fixed lookback.
- Color palettes are defined as module-level dicts (`GDP_COLORS`, `CA_COLORS`, `TRADE_COLORS`, `LF_COLORS`) — maintain consistency when adding new series.
